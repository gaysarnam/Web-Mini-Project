<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>College Central Admin Dashboard - Final Version</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>
    <style>
        /* -------------------------
           Fonts & root variables
           ------------------------- */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');

        :root{
            --bg: #f0f4f8;
            --card: #ffffff;
            --muted: #64748b;
            --text: #1e293b;
            --accent: #3b82f6;
            --accent-600: #2563eb;
            --accent-700: #1d4ed8;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --sidebar: #1e293b;
            --sidebar-gradient: linear-gradient(180deg, #1e293b, #334155);
            --shadow-sm: 0 4px 12px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 8px 24px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 16px 40px rgba(0, 0, 0, 0.12);
            --radius-lg: 16px;
            --radius-sm: 10px;
            --trans: 250ms cubic-bezier(.4,0,.2,1);
            --input-bg: #f8fafc;
            --placeholder: #94a3b8;
            --highlight: rgba(59, 130, 246, 0.08);
            --border: #e2e8f0;
            --hover-bg: #f1f5f9;
            --gradient-color-1: rgba(59, 130, 246, 0.15);
            --gradient-color-2: rgba(16, 185, 129, 0.15);
            --gradient-color-3: rgba(139, 92, 246, 0.15);
        }

        /* dark theme variables */
        .dark {
            --bg: #0f172a;
            --card: #1e293b;
            --muted: #94a3b8;
            --text: #f1f5f9;
            --accent: #60a5fa;
            --accent-600: #3b82f6;
            --accent-700: #2563eb;
            --danger: #f87171;
            --success: #34d399;
            --warning: #fbbf24;
            --sidebar: #0f172a;
            --sidebar-gradient: linear-gradient(180deg, #0f172a, #1e293b);
            --shadow-sm: 0 4px 12px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 8px 24px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 16px 40px rgba(0, 0, 0, 0.5);
            --input-bg: #334155;
            --placeholder: #64748b;
            --highlight: rgba(96, 165, 250, 0.1);
            --border: #334155;
            --hover-bg: #334155;
            --gradient-color-1: rgba(96, 165, 250, 0.25);
            --gradient-color-2: rgba(52, 211, 153, 0.25);
            --gradient-color-3: rgba(167, 139, 250, 0.25);
        }

        *{box-sizing:border-box}
        html,body{height:100%}
        body{
            margin:0;
            font-family:"Poppins",system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
            background:var(--bg);
            color:var(--text);
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
            line-height: 1.6;
            position: relative;
            overflow-x: hidden;
            display: flex;
            transition: background-color 0.3s, color 0.3s;
        }

        /* Enhanced animated gradient background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, var(--gradient-color-1), var(--gradient-color-2), var(--gradient-color-3));
            z-index: -1;
            animation: gradientShift 12s ease infinite;
        }

        @keyframes gradientShift {
            0% {
                background: linear-gradient(45deg, var(--gradient-color-1), var(--gradient-color-2), var(--gradient-color-3));
                opacity: 0.9;
                transform: scale(1);
            }
            25% {
                background: linear-gradient(135deg, var(--gradient-color-2), var(--gradient-color-3), var(--gradient-color-1));
                opacity: 1;
                transform: scale(1.05);
            }
            50% {
                background: linear-gradient(225deg, var(--gradient-color-3), var(--gradient-color-1), var(--gradient-color-2));
                opacity: 1;
                transform: scale(1.1);
            }
            75% {
                background: linear-gradient(315deg, var(--gradient-color-1), var(--gradient-color-3), var(--gradient-color-2));
                opacity: 1;
                transform: scale(1.05);
            }
            100% {
                background: linear-gradient(45deg, var(--gradient-color-1), var(--gradient-color-2), var(--gradient-color-3));
                opacity: 0.9;
                transform: scale(1);
            }
        }

        /* Enhanced floating particles */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: -1;
            pointer-events: none;
        }

        .particle {
            position: absolute;
            display: block;
            pointer-events: none;
            opacity: 0.7;
            animation: float 15s infinite;
        }

        .particle::before {
            content: '';
            position: absolute;
            width: 100%;
            box-shadow: 1px 0 5px rgba(0,0,0,0.2);
        }

        /* --- Main Content Area --- */
        .main-content { 
            flex-grow: 1; 
            padding: 30px; 
            position: relative; /* Needed to correctly position the notification bell */
        }
        .header { 
            margin-bottom: 20px; 
            border-bottom: 1px solid #ddd; 
            padding-bottom: 10px; 
            display: flex; 
            /* CENTER THE HEADER TEXT */
            justify-content: center; 
            align-items: center; 
            flex-direction: column; 
            text-align: center; 
        }
        .header > div:first-child { 
            width: 100%; 
            text-align: center; 
        }
        .header h1 { 
            margin:0; 
            color:var(--text);
            font-size: 28px;
            font-weight: 700;
        }
        .header p {
            margin: 8px 0 0 0;
            color: var(--muted);
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .user-info button { 
            background:var(--card); 
            border: none; 
            color: var(--text);
            cursor: pointer; 
            font-size: 20px;
            padding: 12px;
            border-radius: 14px;
            box-shadow: var(--shadow-sm);
            transition: all var(--trans);
            position: relative; 
        }
        .user-info button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        #notification-count { 
            position: absolute; 
            top: -8px; 
            right: -8px; 
            background: var(--danger); 
            color: white; 
            border-radius: 50%; 
            padding: 2px 6px; 
            font-size: 12px; 
            line-height: 1;
            display: block; 
            min-width: 18px;
            text-align: center;
        }
        .hidden { display: none !important; }
        
        /* Content Cards */
        .card { 
            background: var(--card); 
            padding: 24px; 
            border-radius: var(--radius-lg); 
            box-shadow: var(--shadow-md); 
            margin-bottom: 24px; 
            transition: all var(--trans);
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        .card h3 {
            margin-top: 0;
            margin-bottom: 20px; 
            font-size: 20px;
            color: var(--text);
        }
        
        /* Tables and Status */
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; border-bottom: 1px solid var(--border); text-align: left; }
        th {
            font-weight: 600;
            color: var(--text);
            background-color: var(--hover-bg);
        }
        .status-active { color: var(--success); font-weight: bold; }
        .status-banned { color: var(--danger); font-weight: bold; }
        .status-new { color: var(--accent); font-weight: bold; }
        .status-in-progress { color: var(--warning); font-weight: bold; }
        .status-resolved { color: var(--success); font-weight: bold; }
        .tag { padding: 3px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold; color: white; }
        .tag-problem { background-color: var(--danger); }
        .tag-suggestion { background-color: #9b59b6; }
        
        /* Forms and Buttons */
        .avatar-container { 
            width: 100px; 
            height: 100px; 
            border-radius: 50%; 
            background: var(--accent); 
            color: white; 
            font-size: 50px; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            overflow: hidden; 
            margin: 0 auto 20px; 
        }
        input[type="text"], input[type="email"], input[type="number"], input[type="password"], select { 
            width: 100%; 
            padding: 14px; 
            margin-bottom: 15px; 
            border: 1px solid var(--border); 
            border-radius: var(--radius-sm); 
            box-sizing: border-box; 
            background: var(--input-bg);
            color: var(--text);
            transition: all var(--trans);
        }
        input[type="text"]:focus, input[type="email"]:focus, input[type="number"]:focus, input[type="password"]:focus, select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--highlight);
        }
        .form-group { margin-bottom: 15px; }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text);
        }
        .toggle-switch { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px; 
        }
        .toggle-switch input[type="checkbox"] {
            width: auto;
            margin: 0;
            height: 20px;
            width: 40px;
            appearance: none;
            background-color: var(--border);
            border-radius: 20px;
            position: relative;
            cursor: pointer;
            transition: all var(--trans);
        }
        .toggle-switch input[type="checkbox"]:checked {
            background-color: var(--accent);
        }
        .toggle-switch input[type="checkbox"]::before {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: white;
            top: 2px;
            left: 2px;
            transition: all var(--trans);
        }
        .toggle-switch input[type="checkbox"]:checked::before {
            left: 22px;
        }
        
        /* Button Styles */
        .btn-primary { 
            background: linear-gradient(135deg,var(--accent),var(--accent-600));
            color: white; 
            padding: 12px 20px; 
            border: none; 
            border-radius: var(--radius-sm); 
            cursor: pointer; 
            font-weight: 600;
            transition: all var(--trans);
            box-shadow: var(--shadow-sm);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            background: linear-gradient(135deg,var(--accent-600),var(--accent-700));
        }
        .btn-warning { 
            background: linear-gradient(135deg,var(--warning),#d97706);
            color: white; 
            padding: 12px 20px; 
            border: none; 
            border-radius: var(--radius-sm); 
            cursor: pointer; 
            float: right; 
            margin-left: 10px;
        }
        
        /* --- Profile Button Styling for Smaller Length and Curves --- */
        #profile-view .btn-primary,
        #profile-view .btn-warning,
        #profile-view .btn-danger {
            /* Common styles for profile buttons */
            max-width: 250px; /* Limits the length */
            margin-left: auto;
            margin-right: auto;
            display: block;
            border-radius: var(--radius-sm);
            padding: 12px 20px;
            font-weight: 600;
            box-sizing: border-box;
            border: none;
            cursor: pointer;
            transition: all var(--trans);
        }
        
        #profile-view .btn-primary { 
            background: linear-gradient(135deg,#f1c40f,#e6b70c);
            color: black;
            border: 1px solid #c8a30d;
        }
        #profile-view .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        #profile-view .btn-warning { 
            background: linear-gradient(135deg,var(--warning),#d97706);
            color: white; 
            margin-top: 10px; 
        }
        #profile-view .btn-warning:hover {
            background-color: #d35400; 
        }

        /* 3. Logout (Danger) Button - Red */
        #profile-view .btn-danger { 
            background-color: #e74c3c; /* Red */
            color: white; 
            margin-top: 20px; 
        }
        #profile-view .btn-danger:hover {
            background-color: #c0392b; 
        }


        /* Modal Styles */
        .modal { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(0, 0, 0, 0.5); 
            display: none; 
            justify-content: center; 
            align-items: center; 
            z-index: 1000;
            backdrop-filter: blur(4px);
        }
        .modal-content { 
            background: var(--card); 
            padding: 30px; 
            border-radius: var(--radius-lg); 
            max-width: 600px; 
            width: 90%; 
            position: relative; 
            box-shadow: var(--shadow-lg);
            animation: modalSlideIn 0.3s ease;
        }
        @keyframes modalSlideIn {
            from {
                transform: translateY(-30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        .close-btn { 
            position: absolute; 
            top: 15px; 
            right: 15px; 
            font-size: 20px; 
            cursor: pointer;
            color: var(--muted);
            transition: all var(--trans);
        }
        .close-btn:hover {
            color: var(--text);
            transform: scale(1.1);
        }
        
        /* Settings View Specific Styling */
        #settings-view {
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: flex-start; 
            flex-grow: 1; 
            min-height: calc(100vh - 60px); 
            padding-top: 30px; 
        }

        #settings-view .card {
            max-width: 600px; 
            width: 100%; 
            margin: 20px auto; 
        }
        #settings-view .card:first-of-type {
             margin-top: 0;
        }

        /* Comments List */
        #comments-list {
            list-style: none; 
            padding: 0;
        }
        #comments-list li {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            position: relative;
        }
        #comments-list li:last-child {
            border-bottom: none;
        }

        /* Notification List */
        #notification-list {
            list-style: none; 
            padding: 0;
        }
        #notification-list li {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: all var(--trans);
        }
        #notification-list li:hover {
            background: var(--hover-bg);
        }
        #notification-list li:last-child {
            border-bottom: none;
        }
        #notification-list li.unread {
            font-weight: 600;
            color: var(--accent);
        }

        /* Responsive Design */
        @media (max-width:980px){
            .sidebar{display:none}
            .main-content{padding:16px}
            .modal-content {
                width: 95%;
                padding: 20px;
            }
        }
    </style>
</head>
<body>

    <!-- Enhanced animated background elements -->
    <div class="particles" id="particles"></div>
    <div class="shapes" id="shapes"></div>

    <div class="sidebar">
        <div class="brand">
            <div class="logo">AD</div>
            <div>
                <h1>Admin Panel</h1>
                <div style="font-size:13px;color:rgba(255,255,255,0.7)">College Central</div>
            </div>
        </div>
        
        <a href="#" id="dashboard-link" class="active">Dashboard (Posts)</a>
        <a href="#" id="favorites-link">Favorites (<span id="fav-count">0</span>)</a>
        <a href="#" id="users-link">User Management</a>
        
        <a href="#" id="profile-link">Profile</a>
        <a href="#" id="settings-link">Settings</a>
    </div>

    <div class="main-content">
        <div class="header">
            <div>
                <h1 id="main-title">Moderation Central</h1>
                <p id="main-description">Review and moderate user-submitted problems and suggestions.</p>
            </div>
            <div class="user-info">
                <button id="theme-toggle" title="Toggle dark mode"><i class="fas fa-moon"></i></button>
                <button id="notification-bell" title="Notifications"><i class="fas fa-bell"></i><span id="notification-count" style="display: none;"></span></button>
            </div>
        </div>
        
        <div id="posts-view">
            <div class="card">
                <h3>Post Tracker</h3>
                <input type="text" id="search-input" placeholder="Search posts by subject, user, or content...">
                <table id="post-table">
                    <thead>
                        <tr><th>ID</th><th>Subject</th><th>Status</th><th>User</th><th>Actions</th></tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </div>

        <div id="archive-view" class="hidden">
            <div class="card">
                <h3>Archived Posts</h3>
                <input type="text" id="archive-search-input" placeholder="Search archived posts by subject, user, or content...">
                <table id="archive-table">
                    <thead>
                        <tr><th>ID</th><th>Subject</th><th>Status</th><th>User</th><th>Actions</th></tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </div>

        <div id="users-view" class="hidden">
             <div class="card">
                <h3>Registered Users</h3>
                <input type="text" id="user-search-input" placeholder="Search users by username or email...">
                <table>
                    <thead>
                        <tr><th>ID</th><th>Username</th><th>Email</th><th>Status</th><th>Actions</th></tr>
                    </thead>
                    <tbody id="user-table-body">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="profile-view" class="hidden">
            <div class="card" style="max-width: 400px; margin: 0 auto;">
                <h3>Your Administrator Profile</h3>
                <div id="current-profile-avatar" class="avatar-container">👤</div>
                <div class="form-group">
                    <label for="profile-pic-input">Change Picture:</label>
                    <input type="file" id="profile-pic-input" accept="image/*">
                </div>
                <div class="form-group">
                    <label for="profile-name">Name:</label>
                    <input type="text" id="profile-name" required>
                </div>
                <div class="form-group">
                    <label for="profile-username">Username:</label>
                    <input type="text" id="profile-username" required>
                </div>
                <div class="form-group">
                    <label for="profile-email">Email:</label>
                    <input type="email" id="profile-email" required>
                </div>
                <button id="save-profile-btn" class="btn-primary">Save Changes</button>
                
                <button id="reset-password-btn" class="btn-warning">Reset Password</button>
            </div>
        </div>

        <div id="settings-view" class="hidden">
            <div class="card">
                <h3>Moderation Defaults</h3>
                <div class="form-group">
                    <label for="default-status">Default New Post Status:</label>
                    <select id="default-status">
                        <option value="New">New</option>
                        <option value="In Progress">In Progress</option>
                    </select>
                </div>
                 <div class="form-group">
                    <label for="rows-per-page">Tickets per page (5-50):</label>
                    <input type="number" id="rows-per-page" min="5" max="50">
                </div>
                
                <hr style="margin: 20px 0; border: none; border-top: 1px solid var(--border);">
                
                <h3>Notification Settings</h3>
                <div class="toggle-switch">
                    <label for="notify-user-status">Notify on user status change (Ban/Unban)</label>
                    <input type="checkbox" id="notify-user-status">
                </div>
                <div class="toggle-switch">
                    <label for="notify-new-comment">Notify on new comments to tracked posts</label>
                    <input type="checkbox" id="notify-new-comment">
                </div>
                
                <button id="save-settings-btn" class="btn-primary">Save Settings</button>
            </div>
            
            <div class="card">
                <h3>Maintenance Actions</h3>
                <button id="archive-old-data-btn" class="btn-primary" style="background-color: #f39c12;">Archive Resolved Tickets</button>
                <button id="clear-notifications-btn" class="btn-primary" style="background-color: #7f8c8d;">Clear Read Notifications</button>
            </div>
        </div>

    </div>
    
    <div id="details-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" data-action="close-modal">&times;</span>
            <h2 id="modal-title">Ticket Details</h2>
            <p>ID: <strong id="modal-id"></strong> | Subject: <strong id="modal-subject"></strong></p>
            
            <h4 style="margin-top: 20px;">Content:</h4>
            <p id="modal-content" style="border: 1px dashed var(--border); padding: 10px; border-radius: var(--radius-sm);"></p>
            
            <h4 style="margin-top: 20px;">Comments (<span id="comment-count">0</span>):</h4>
            <ul id="comments-list" style="list-style: none; padding: 0;">
                </ul>
        </div>
    </div>
    
    <div id="notification-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" data-action="close-modal">&times;</span>
            <h2>Notifications</h2>
            <ul id="notification-list" style="list-style: none; padding: 0;">
                </ul>
        </div>
    </div>

    <script>
        // --- Mock Database: POSTS (Initial Data) ---
        let posts = [
            { 
                id: 101, 
                type: 'Problem', 
                subject: 'Wi-Fi slow in North Dorm', 
                content: 'The campus Wi-Fi speed drops significantly after 7 PM in the North Dorm block. Students cannot attend online classes.', 
                status: 'New', 
                user: 'Aisha K.',
                isFavorite: false,
                isArchived: false,
                comments: [
                    { id: 1, user: 'Admin', text: 'Thanks for the report. Escalating to IT.' },
                    { id: 2, user: 'Ben J.', text: 'I second this. It\'s unusable.' },
                    { id: 3, user: 'User 404', text: 'This is a totally inappropriate comment and should be deleted.' }
                ]
            },
            { 
                id: 102, 
                type: 'Suggestion', 
                subject: 'Add more study pods in the library', 
                content: 'Suggest adding more soundproof study pods on the third floor for group work.', 
                status: 'Resolved', 
                user: 'Chris T.',
                isFavorite: false,
                isArchived: false,
                comments: []
            },
            { 
                id: 103, 
                type: 'Problem', 
                subject: 'Broken Water Fountain near Gym', 
                content: 'The water fountain has been leaking for a week. Needs urgent repair.', 
                status: 'In Progress', 
                user: 'Dana M.',
                isFavorite: false,
                isArchived: false,
                comments: [
                    { id: 4, user: 'Admin', text: 'Plumbing team is on it.' }
                ]
            }
        ];

        // --- Mock Database: USERS ---
        let users = [
            { id: 1, username: 'Aisha K.', email: 'aisha.k@college.edu', status: 'Active' },
            { id: 2, username: 'Chris T.', email: 'chris.t@college.edu', status: 'Active' },
            { id: 3, username: 'Prof. Smith', email: 'smith.p@college.edu', status: 'Active' },
            { id: 4, username: 'User 404', email: 'user404@college.edu', status: 'Banned' }
        ];

        // --- Mock Database: CURRENT ADMIN (Initial Data) ---
        let currentAdmin = {
            id: 1001,
            username: 'Moderator_Alpha',
            email: 'admin@collegecentral.edu',
            role: 'Senior Moderator',
            status: 'Active (Full Access)',
            avatarUrl: '',
            // Mock Password for Reset Functionality - Stored in Plain Text for this mock demo
            password: 'password123' 
        };

        // --- Mock Database: ADMIN SETTINGS (Initial Data) ---
        let adminSettings = {
            darkMode: false,
            defaultPostStatus: 'New',
            rowsPerPage: 10,
            notifyUserStatus: true,
            notifyNewComment: true
        };

        // --- Mock Notifications ---
        let notifications = [
            { id: 1, message: "New Problem posted: 'Wi-Fi slow in North Dorm'", unread: true },
            { id: 2, message: "User 'Ben J.' replied to ticket 101.", unread: true },
            { id: 3, message: "System backup completed successfully.", unread: false }
        ];

        // --- DOM Element Declarations ---
        const $ = (id) => document.getElementById(id);

        const postTableBody = document.querySelector('#post-table tbody');
        const archiveTableBody = document.querySelector('#archive-table tbody');
        const userTableBody = $('user-table-body');
        const postsView = $('posts-view');
        const archiveView = $('archive-view');
        const usersView = $('users-view');
        const profileView = $('profile-view');
        const settingsView = $('settings-view'); 
        const mainTitle = $('main-title');
        const mainDescription = $('main-description');
        const notificationModal = $('notification-modal');
        const notificationList = $('notification-list');
        const notificationCount = $('notification-count');
        const detailsModal = $('details-modal');
        const commentsList = $('comments-list');
        const profilePicInput = $('profile-pic-input');
        const currentProfileAvatar = $('current-profile-avatar');
        const saveProfileBtn = $('save-profile-btn');
        const saveSettingsBtn = $('save-settings-btn');
        const resetPasswordBtn = $('reset-password-btn');
        const particles = $('#particles');
        const shapes = $('#shapes');

        // ----------------------------------------------------------------------
        //                  DATA PERSISTENCE
        // ----------------------------------------------------------------------
        function loadPersistentData() {
            // 1. Load Admin Profile
            const savedProfile = localStorage.getItem('adminProfile');
            if (savedProfile) {
                currentAdmin = JSON.parse(savedProfile);
                // Ensure the mock password exists if not saved before
                if (!currentAdmin.password) {
                     currentAdmin.password = 'password123';
                }
            } else {
                 // Set initial mock data if no local storage found
                 localStorage.setItem('adminProfile', JSON.stringify(currentAdmin));
            }
            
            // 2. Load Settings
            const savedSettings = localStorage.getItem('adminSettings');
            if (savedSettings) {
                adminSettings = JSON.parse(savedSettings);
            }
        }


        // ----------------------------------------------------------------------
        //                                VIEW SWITCHING
        // ----------------------------------------------------------------------

        function setActiveLink(clickedLink) {
            document.querySelector('.sidebar a.active')?.classList.remove('active');
            clickedLink.classList.add('active');
        }

        function showView(viewName) {
            // Hide all views first
            postsView.classList.add('hidden');
            archiveView.classList.add('hidden');
            usersView.classList.add('hidden');
            profileView.classList.add('hidden');
            settingsView.classList.add('hidden'); 

            // Show the requested view
            if (viewName === 'posts') {
                postsView.classList.remove('hidden');
                mainTitle.textContent = "Moderation Central";
                mainDescription.textContent = "Review and moderate user-submitted problems and suggestions.";
                // Note: renderPosts is called in the event listeners for dashboard/favorites
            } else if (viewName === 'archive') {
                archiveView.classList.remove('hidden');
                mainTitle.textContent = "Archived Posts";
                mainDescription.textContent = "View and manage your archived posts.";
                renderArchivedPosts();
            } else if (viewName === 'users') {
                usersView.classList.remove('hidden');
                mainTitle.textContent = "User Management Console";
                mainDescription.textContent = "View, search, and manage user accounts and statuses.";
                renderUsers(users); 
            } else if (viewName === 'profile') {
                profileView.classList.remove('hidden');
                mainTitle.textContent = "Edit Administrator Profile";
                mainDescription.textContent = "Update your credentials and account settings.";
                renderProfile(currentAdmin);
            } else if (viewName === 'settings') { 
                settingsView.classList.remove('hidden');
                mainTitle.textContent = "Application Settings";
                mainDescription.textContent = "Manage dashboard defaults and notifications.";
                loadAdminSettings(); 
            }
        }

        // ----------------------------------------------------------------------
        //                  PROFILE & SIDEBAR RENDERING
        // ----------------------------------------------------------------------

        function renderSidebarProfile(admin) {
            const sidebarName = $('sidebarName');
            const sidebarPic = $('sidebarPic');
            
            sidebarName.textContent = admin.username;
            sidebarPic.textContent = (admin.username && admin.username[0]) ? admin.username[0].toUpperCase() : 'A';
        }

        function renderProfile(admin) {
            // Update Form fields
            $('profile-name').value = admin.username; 
            $('profile-username').value = admin.username;
            $('profile-email').value = admin.email;
            
            // Update Profile View Avatar
            if (admin.avatarUrl) {
                currentProfileAvatar.innerHTML = `<img src="${admin.avatarUrl}" alt="Admin Avatar" style="width:100%; height:100%; object-fit:cover;">`;
            } else {
                currentProfileAvatar.innerHTML = '👤'; 
            }
        }

        function handleProfilePictureChange(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentAdmin.avatarUrl = e.target.result; 
                    renderProfile(currentAdmin);
                    alert('New profile picture loaded! Click "Save Changes" to finalize.');
                };
                reader.readAsDataURL(file);
            }
        }

        function saveProfileChanges() {
            const newName = $('profile-name').value.trim();
            const newUsername = $('profile-username').value.trim();
            const newEmail = $('profile-email').value.trim();

            if (!newName || !newUsername || !newEmail) {
                alert("Please fill out all required fields.");
                return;
            }

            currentAdmin.username = newUsername; 
            currentAdmin.email = newEmail;
            
            // Save to Local Storage for persistence
            localStorage.setItem('adminProfile', JSON.stringify(currentAdmin));

            // Update UI elements
            renderSidebarProfile(currentAdmin); 
            renderProfile(currentAdmin); 
            
            alert(`Profile updated successfully! New Username: ${newUsername}`);
        }

        // Password Reset Functionality
        function handlePasswordReset() {
            const oldPassword = prompt("Please enter your current password:");
            
            if (oldPassword === null) return; // User cancelled

            if (oldPassword !== currentAdmin.password) {
                alert("Error: The current password you entered is incorrect.");
                return;
            }

            const newPassword = prompt("Enter your NEW password (must be at least 6 characters):");

            if (newPassword === null) return; // User cancelled
            
            if (newPassword.length < 6) {
                alert("Error: New password must be at least 6 characters long.");
                return;
            }

            const confirmPassword = prompt("Confirm your NEW password:");

            if (confirmPassword === null) return; // User cancelled

            if (newPassword !== confirmPassword) {
                alert("Error: The new passwords do not match.");
                return;
            }

            // Update password in mock database and localStorage
            currentAdmin.password = newPassword;
            localStorage.setItem('adminProfile', JSON.stringify(currentAdmin));

            alert("Success! Your password has been updated. Please remember your new password.");
        }

        // ----------------------------------------------------------------------
        //                  SETTINGS FUNCTIONS
        // ----------------------------------------------------------------------

        function loadAdminSettings() {
            // Moderation Defaults
            $('default-status').value = adminSettings.defaultPostStatus;
            $('rows-per-page').value = adminSettings.rowsPerPage;

            // Notification Settings
            $('notify-user-status').checked = adminSettings.notifyUserStatus;
            $('notify-new-comment').checked = adminSettings.notifyNewComment;
        }

        function saveAdminSettings() {
            // 1. Gather values
            const defaultStatus = $('default-status').value;
            const rowsPerPage = parseInt($('rows-per-page').value, 10);
            const notifyUserStatus = $('notify-user-status').checked;
            const notifyNewComment = $('notify-new-comment').checked;
            
            if (rowsPerPage < 5 || rowsPerPage > 50 || isNaN(rowsPerPage)) {
                alert("Tickets per page must be between 5 and 50.");
                $('rows-per-page').value = adminSettings.rowsPerPage;
                return;
            }

            // 2. Update the mock data object
            adminSettings.defaultPostStatus = defaultStatus;
            adminSettings.rowsPerPage = rowsPerPage;
            adminSettings.notifyUserStatus = notifyUserStatus;
            adminSettings.notifyNewComment = notifyNewComment;

            // 3. Save to Local Storage
            localStorage.setItem('adminSettings', JSON.stringify(adminSettings));

            // 4. Provide feedback
            alert('Application Settings saved successfully!');
        }

        // ----------------------------------------------------------------------
        //                  OTHER DASHBOARD FUNCTIONS
        // ----------------------------------------------------------------------

        function renderPosts(data) {
            postTableBody.innerHTML = '';
            const favCount = posts.filter(p => p.isFavorite && !p.isArchived && p.status !== 'Deleted').length;
            $('fav-count').textContent = favCount;
            
            data.forEach(post => {
                if (post.status !== 'Deleted' && !post.isArchived) { 
                    const row = postTableBody.insertRow();
                    let statusClass = `status-${post.status.toLowerCase().replace(' ', '-')}`;
                    const starIcon = post.isFavorite ? '★' : '☆'; 
                    const favClass = post.isFavorite ? 'is-favorited' : '';

                    row.innerHTML = `
                        <td>${post.id}</td>
                        <td>${post.subject}</td>
                        <td><span class="${statusClass}">${post.status}</span></td>
                        <td>${post.user}</td>
                        <td>
                            <button class="action-btn btn-view" onclick="openDetailsModal(${post.id})">View</button>
                            <button class="action-btn btn-delete" onclick="deletePost(${post.id})">Delete</button>
                            <button class="btn-favorite ${favClass}" onclick="toggleFavorite(${post.id})">${starIcon}</button>
                        </td>
                    `;
                }
            });
        }
        window.toggleFavorite = function(postId) {
            const post = posts.find(p => p.id === postId);
            if (post) {
                post.isFavorite = !post.isFavorite; 
                // Re-render the current list (either all posts or just favorites)
                const currentLink = document.querySelector('.sidebar a.active')?.id;
                if (currentLink === 'favorites-link') {
                    const favoritePosts = posts.filter(p => p.isFavorite && !p.isArchived);
                    renderPosts(favoritePosts);
                } else if (currentLink === 'archive-link') {
                    renderArchivedPosts();
                } else {
                    renderPosts(posts); 
                }
            }
        }
        window.deletePost = function(postId) {
            if (!confirm('DANGER: Are you sure you want to delete this entire post? This action is not reversible.')) return;
            const postIndex = posts.findIndex(p => p.id === postId);
            if (postIndex !== -1) {
                const wasArchived = posts[postIndex].isArchived;
                posts[postIndex].status = 'Deleted'; 
                
                // If the post was archived, update the archived list
                if (wasArchived) {
                    const archivedIds = posts.filter(p => p.isArchived).map(p => p.id);
                    localStorage.setItem('archivedPosts', JSON.stringify(archivedIds));
                    
                    // Update archive count immediately
                    $('archive-count').textContent = archivedIds.length;
                }
                
                // Re-render the current view
                const currentLink = document.querySelector('.sidebar a.active')?.id;
                if (currentLink === 'archive-link') {
                    renderArchivedPosts();
                } else {
                    renderPosts(posts); 
                }
                
                alert(`Post ${postId} has been marked as Deleted.`);
            }
        }

        function filterPosts() {
            const searchTerm = $('search-input').value.toLowerCase();
            const filteredPosts = posts.filter(post => 
                (post.status !== 'Deleted' && !post.isArchived) && (
                post.subject.toLowerCase().includes(searchTerm) ||
                post.content.toLowerCase().includes(searchTerm) ||
                post.type.toLowerCase().includes(searchTerm)
                )
            );
            renderPosts(filteredPosts);
        }
        function renderUsers(data) {
            userTableBody.innerHTML = '';
            data.forEach(user => {
                const row = userTableBody.insertRow();
                const statusClass = user.status.toLowerCase() === 'active' ? 'status-active' : 'status-banned';
                const actionText = user.status === 'Active' ? 'Ban User' : 'Unban User';
                const actionClass = user.status === 'Active' ? 'btn-ban' : 'btn-unban';

                row.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.username}</td>
                    <td>${user.email}</td>
                    <td class="${statusClass}">${user.status}</td>
                    <td>
                        <button class="${actionClass}" data-action="toggle-user-status" data-user-id="${user.id}">${actionText}</button>
                    </td>
                `;
            });
        }

        function filterUsers() {
            const searchTerm = $('user-search-input').value.toLowerCase();
            const filteredUsers = users.filter(user => 
                user.username.toLowerCase().includes(searchTerm) ||
                user.email.toLowerCase().includes(searchTerm)
            );
            renderUsers(filteredUsers);
        }

        function renderNotifications() {
            notificationList.innerHTML = '';
            const unreadCount = notifications.filter(n => n.unread).length;
            
            notificationCount.textContent = unreadCount > 0 ? unreadCount : ''; 
            notificationCount.style.display = unreadCount > 0 ? 'block' : 'none';

            if (notifications.length === 0) {
                        notificationList.innerHTML = '<li>No new notifications.</li>';
                        return;
            }

            notifications.forEach(notification => {
                const li = document.createElement('li');
                li.textContent = notification.message;
                li.dataset.notificationId = notification.id;
                
                if (notification.unread) {
                    li.classList.add('unread');
                }

                li.addEventListener('click', function() {
                    const notificationId = parseInt(this.dataset.notificationId);
                    markAsRead(notificationId);
                });
                
                notificationList.appendChild(li);
            });
        }

        function openNotificationModal() { 
            notificationModal.style.display = 'flex'; 
        }

        function closeNotificationModal() { 
            notificationModal.style.display = 'none'; 
        }

        function markAsRead(id) {
            const notification = notifications.find(n => n.id === id);
            if (notification) {
                notification.unread = false;
                renderNotifications();
            }
        }

        function openDetailsModal(postId) {
            const post = posts.find(p => p.id === postId);
            if (!post) return;
            $('modal-id').textContent = post.id;
            $('modal-subject').textContent = post.subject;
            $('modal-content').textContent = post.content;
            $('modal-title').textContent = `${post.type} - ID: ${post.id}`;
            
            commentsList.innerHTML = '';
            $('comment-count').textContent = post.comments.length;

            post.comments.forEach(comment => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <div><strong>${comment.user}:</strong> ${comment.text}</div>
                    <button class="btn-delete-comment" data-action="delete-comment" data-post-id="${post.id}" data-comment-id="${comment.id}">Delete</button>
                `;
                commentsList.appendChild(li);
            });
            detailsModal.style.display = 'flex';
        }

        function closeDetailsModal() { 
            detailsModal.style.display = 'none'; 
        }

        function deleteComment(postId, commentId) {
            if (!confirm('WARNING: Are you sure you want to delete this comment?')) return;
            const post = posts.find(p => p.id === postId);
            if (post) {
                post.comments = post.comments.filter(c => c.id !== commentId);
                // Re-open the modal to refresh the comment list
                openDetailsModal(postId); 
                alert(`Comment ${commentId} has been removed.`);
            }
        }

        function toggleUserStatus(userId) {
            const user = users.find(u => u.id === userId);
            if (user) {
                user.status = user.status === 'Active' ? 'Banned' : 'Active';
                renderUsers(users);
                alert(`User ${user.username} has been ${user.status.toLowerCase()}.`);
            }
        }

        window.archiveOldData = function() {
            if (confirm("Are you sure you want to mock-archive resolved tickets? This will remove them from the dashboard view.")) {
                const resolvedCount = posts.filter(p => p.status === 'Resolved').length;
                if (resolvedCount === 0) {
                    alert("No resolved tickets found to archive.");
                    return;
                }
                posts = posts.filter(p => p.status !== 'Resolved');
                renderPosts(posts);
                alert(`${resolvedCount} ticket(s) have been successfully archived and removed from the dashboard.`);
            }
        }
        window.clearReadNotifications = function() {
            const readCount = notifications.filter(n => !n.unread).length;
            if (readCount === 0) {
                alert("No read notifications to clear.");
                return;
            }
            notifications = notifications.filter(n => n.unread);
            renderNotifications();
            alert(`${readCount} read notification(s) cleared.`);
        }


        // ----------------------------------------------------------------------
        //                        INITIALIZATION & EVENT LISTENERS
        // ----------------------------------------------------------------------

        document.addEventListener('DOMContentLoaded', () => {
            
            // 1. LOAD PERSISTENT DATA FIRST
            loadPersistentData(); 
            
            // Apply theme setting immediately based on loaded data
            applyTheme(); 

            // Attach Sidebar Handlers
            $('dashboard-link').onclick = function(e) {
                e.preventDefault();
                setActiveLink(e.target);
                showView('posts');
                renderPosts(posts); // Show all posts
            };

            $('favorites-link').onclick = function(e) {
                e.preventDefault();
                setActiveLink(e.target);
                const favoritePosts = posts.filter(p => p.isFavorite);
                showView('posts');
                renderPosts(favoritePosts); // Show only favorites
                mainTitle.textContent = "My Favorite Tickets ⭐";
                mainDescription.textContent = "Quick access to tickets you've marked as important.";
            };

            $('users-link').onclick = function(e) {
                e.preventDefault();
                setActiveLink(e.target);
                showView('users');
            };
            
            $('profile-link').onclick = function(e) {
                e.preventDefault();
                setActiveLink(e.target);
                showView('profile');
            };
            
            $('settings-link').onclick = function(e) {
                e.preventDefault();
                setActiveLink(e.target);
                showView('settings'); 
            };
            
            // --- ACTION BUTTON LISTENERS ---
            logoutBtnProfile.onclick = function() {
                alert('Logging out... Thank you for your service!');
                // In a real app, this clears the session and redirects to login.
            };
            
            // Reset Password Listener
            resetPasswordBtn.addEventListener('click', handlePasswordReset);

            $('notification-bell').onclick = openNotificationModal;
            
            // --- PROFILE FUNCTIONALITY LISTENERS ---
            profilePicInput.addEventListener('change', handleProfilePictureChange);
            saveProfileBtn.addEventListener('click', saveProfileChanges);
            
            // --- SETTINGS FUNCTIONALITY LISTENERS ---
            saveSettingsBtn.addEventListener('click', saveAdminSettings);
            $('archive-old-data-btn').addEventListener('click', archiveOldData);
            $('clear-notifications-btn').addEventListener('click', clearReadNotifications);
            
            
            // --- Initial Render ---
            renderPosts(posts);
            renderNotifications();
            loadAdminSettings(); 
            showView('posts'); 
            
            // Render profile and sidebar using the loaded persistent data
            renderSidebarProfile(currentAdmin);
            renderProfile(currentAdmin);
        });

        // Close modals when clicking outside of them
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
    </script>
</body>
</html>