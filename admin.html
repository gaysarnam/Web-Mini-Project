<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>College Central Admin Dashboard - Final Version</title>
    <style>
        /* Minimal CSS for structure and visibility */
        body { 
            font-family: sans-serif; 
            margin: 0; 
            background-color: #f0f2f5; /* Light grey background */
            display: flex; 
            transition: background-color 0.3s; 
        }
        
        /* --- Sidebar Container Styles --- */
        .sidebar { 
            width: 250px; 
            background-color: #2c3e50; 
            color: white; 
            height: 100vh; 
            padding-top: 20px; 
            box-shadow: 2px 0 5px rgba(0,0,0,0.1); 
            display: flex; 
            flex-direction: column; 
            transition: background-color 0.3s; 
            /* ADDED CURVE to main sidebar */
            border-top-right-radius: 15px; 
            border-bottom-right-radius: 15px;
            overflow: hidden; 
        }
        
        .sidebar h2 { text-align: center; margin-bottom: 30px; }
        
        /* User Card Spacing */
        #sidebar-user-card { margin-bottom: 30px; } 

        /* --- Sidebar Link Styles (Curved and Spaced) --- */
        .sidebar a { 
            padding: 10px 20px; 
            text-decoration: none; 
            color: #ecf0f1; 
            display: block; 
            border-left: 5px solid transparent; 
            transition: background-color 0.3s; 
            /* CURVE AND SPACE */
            border-radius: 0 8px 8px 0; 
            margin-right: 15px; 
            margin-bottom: 5px; 
            width: calc(100% - 15px); 
        }
        
        /* Active Link Styles */
        .sidebar a:hover, .sidebar a.active { 
            background-color: #34495e; 
            border-left: 5px solid #3498db; 
        }
        .sidebar a.active {
            margin-right: 0px; 
            width: 100%;
            box-shadow: 1px 0 5px rgba(0,0,0,0.2);
        }

        /* --- Main Content Area --- */
        .main-content { 
            flex-grow: 1; 
            padding: 30px; 
            position: relative; /* Needed to correctly position the notification bell */
        }
        .header { 
            margin-bottom: 20px; 
            border-bottom: 1px solid #ddd; 
            padding-bottom: 10px; 
            display: flex; 
            /* CENTER THE HEADER TEXT */
            justify-content: center; 
            align-items: center; 
            flex-direction: column; 
            text-align: center; 
        }
        .header > div:first-child { 
            width: 100%; 
            text-align: center; 
        }
        .header h1 { 
            margin: 0; 
            color: #2c3e50; 
            transition: color 0.3s; 
        }
        .user-info {
            /* Position notification bell to the top-right of the main content area */
            position: absolute; 
            top: 30px; 
            right: 30px;
        }
        .user-info button { 
            background: none; 
            border: none; 
            color: #3498db; 
            cursor: pointer; 
            font-size: 24px; 
            position: relative; 
        }
        #notification-count { 
            position: absolute; 
            top: 0px; 
            right: 0px; 
            background: red; 
            color: white; 
            border-radius: 50%; 
            padding: 0 6px; 
            font-size: 12px; 
            line-height: 18px; 
            display: block; 
        }
        .hidden { display: none !important; }
        
        /* Content Cards (Curved & Heading Centered) */
        .card { 
            background: white; 
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
            margin-bottom: 20px; 
            transition: background-color 0.3s, color 0.3s, box-shadow 0.3s; 
            /* Ensures h3s are centered */
            text-align: center; 
        }

        /* Override the text-align for elements that should remain left-aligned, like tables and inputs */
        .card table, .card input, .card select, .card label, .card .form-group, .card .toggle-switch, .card #comments-list {
            text-align: left;
        }
        .card h3 {
            margin-top: 0;
            margin-bottom: 20px; 
            text-align: center; 
        }
        
        /* Tables and Status */
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; border-bottom: 1px solid #ddd; text-align: left; }
        .status-active { color: green; font-weight: bold; }
        .status-banned { color: red; font-weight: bold; }
        .status-new { color: #3498db; font-weight: bold; }
        .status-in-progress { color: #f39c12; font-weight: bold; }
        .status-resolved { color: #2ecc71; font-weight: bold; }
        .tag { padding: 3px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold; color: white; }
        .tag-problem { background-color: #e74c3c; }
        .tag-suggestion { background-color: #9b59b6; }
        
        /* Forms and Buttons */
        .avatar-container { width: 100px; height: 100px; border-radius: 50%; background: #3498db; color: white; font-size: 50px; display: flex; justify-content: center; align-items: center; overflow: hidden; margin: 0 auto 20px; }
        input[type="text"], input[type="email"], input[type="number"], select { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; transition: background-color 0.3s, color 0.3s, border-color 0.3s; }
        .form-group { margin-bottom: 15px; }
        .toggle-switch { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        
        /* Global Primary Button (used in other views) */
        .btn-primary { 
            background-color: #3498db; 
            color: white; 
            padding: 10px 15px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            margin-right: 10px; 
            transition: background-color 0.3s; 
        }

        .btn-delete-comment { 
            background-color: #e74c3c; 
            color: white; 
            padding: 5px 10px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            float: right; 
            margin-left: 10px;
        }
        
        /* --- Profile Button Styling for Smaller Length and Curves --- */
        #profile-view .btn-primary,
        #profile-view .btn-warning,
        #profile-view .btn-danger {
            /* Common styles for profile buttons */
            max-width: 250px; /* Limits the length */
            margin-left: auto;
            margin-right: auto;
            display: block; 
            border-radius: 8px; /* Curved borders */
            padding: 10px 15px; /* Consistent padding */
            font-weight: bold;
            box-sizing: border-box;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s; 
        }
        
        /* 1. Save Changes (Primary) Button - Custom Yellow Color */
        #profile-view .btn-primary { 
            background-color: #f1c40f; /* Yellow/Gold */
            color: black;
            border: 1px solid #c8a30d;
        }
        #profile-view .btn-primary:hover {
            background-color: #e6b70c;
        }
        
        /* 2. Reset Password (Warning) Button - Orange */
        #profile-view .btn-warning { 
            background-color: #f39c12; /* Orange */
            color: white; 
            margin-top: 10px; 
        }
        #profile-view .btn-warning:hover {
            background-color: #d35400; 
        }

        /* 3. Logout (Danger) Button - Red */
        #profile-view .btn-danger { 
            background-color: #e74c3c; /* Red */
            color: white; 
            margin-top: 20px; 
        }
        #profile-view .btn-danger:hover {
            background-color: #c0392b; 
        }


        /* Modal Styles */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { 
            background: white; 
            padding: 30px; 
            border-radius: 12px; 
            max-width: 600px; 
            width: 90%; 
            position: relative; 
            transition: background-color 0.3s, color 0.3s; 
            text-align: left; 
        }
        .close-btn { position: absolute; top: 10px; right: 10px; font-size: 20px; cursor: pointer; }
        
        /* --- Settings View Specific Styling (Centered, Curved, Light Grey) --- */
        #settings-view {
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: flex-start; 
            flex-grow: 1; 
            min-height: calc(100vh - 60px); 
            padding-top: 30px; 
        }

        #settings-view .card {
            max-width: 600px; 
            width: 100%; 
            margin: 20px auto; 
            background-color: #f8f8f8; 
            border-radius: 15px; 
        }
        #settings-view .card:first-of-type {
             margin-top: 0;
        }


        /* --- DARK MODE STYLES --- */
        .dark-mode {
            background-color: #1e1e1e !important;
            color: #e0e0e0 !important;
        }
        .dark-mode .sidebar {
            background-color: #1a1a1a;
            box-shadow: 2px 0 10px rgba(0,0,0,0.5);
        }
        .dark-mode .sidebar a {
            color: #bdbdbd;
        }
        .dark-mode .sidebar a:hover, .dark-mode .sidebar a.active {
            background-color: #2b2b2b;
            border-left-color: #00bcd4; 
        }
        .dark-mode .header h1 {
            color: #00bcd4;
        }
        .dark-mode .header {
             border-bottom: 1px solid #444;
        }
        .dark-mode .card {
            background: #252526;
            color: #e0e0e0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        /* Dark mode settings card override */
        .dark-mode #settings-view .card {
            background-color: #252526; 
            border: 1px solid #444; 
        }
        .dark-mode table {
            color: #e0e0e0;
        }
        .dark-mode th, .dark-mode td {
            border-bottom: 1px solid #444;
        }
        .dark-mode input[type="text"], .dark-mode input[type="email"], .dark-mode input[type="number"], .dark-mode select {
            background-color: #333;
            color: #e0e0e0;
            border-color: #555;
        }
        .dark-mode .btn-primary {
            background-color: #00bcd4;
        }
        .dark-mode .modal-content {
             background: #252526;
             color: #e0e0e0;
        }
        .dark-mode #comments-list li {
            border-color: #444;
        }

        /* --- HIGH CONTRAST MODE STYLES --- */
        .high-contrast {
            background-color: black !important;
            color: white !important;
        }
        .high-contrast .sidebar {
            background-color: #000;
        }
        .high-contrast .sidebar a, .high-contrast .header h1 {
            color: white;
        }
        .high-contrast .sidebar a.active {
            background-color: #333;
            border-left-color: #ffff00; 
        }
        .high-contrast .card, .high-contrast .modal-content {
            background: #111;
            color: white;
            border: 2px solid white; 
        }
        /* High contrast settings card override */
        .high-contrast #settings-view .card {
            background-color: #111; 
            border: 2px solid white; 
        }
        .high-contrast input[type="text"], .high-contrast input[type="email"], .high-contrast input[type="number"], .high-contrast select {
            background-color: black;
            color: white;
            border: 2px solid white;
        }
        /* Override primary button for high contrast */
        .high-contrast .btn-primary,
        .high-contrast #profile-view .btn-primary,
        .high-contrast #profile-view .btn-warning,
        .high-contrast #profile-view .btn-danger {
            background-color: #ffff00 !important;
            color: black !important;
            font-weight: bold !important;
            border: 2px solid black !important;
        }
        .high-contrast table {
            color: white;
        }
        .high-contrast th, .high-contrast td, .high-contrast .header {
            border-bottom: 1px solid white;
        }
        /* Status Overrides for High Contrast */
        .high-contrast .status-active { color: lime; }
        .high-contrast .status-banned { color: red; }
        .high-contrast .status-new { color: cyan; }
        .high-contrast .status-in-progress { color: yellow; }
        .high-contrast .status-resolved { color: lime; }
        .high-contrast .tag-problem { background-color: red; }
        .high-contrast .tag-suggestion { background-color: magenta; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>Admin Panel</h2>
        <div id="sidebar-user-card" style="text-align: center; margin-bottom: 20px;">
            <div class="user-avatar avatar-container" style="width: 60px; height: 60px; font-size: 30px; margin: 0 auto 10px;">
                </div>
            <strong id="sidebar-admin-name">ADMIN</strong>
        </div>
        
        <a href="#" id="dashboard-link" class="active">Dashboard (Posts)</a>
        <a href="#" id="favorites-link">Favorites (<span id="fav-count">0</span>)</a>
        <a href="#" id="users-link">User Management</a>
        
        <a href="#" id="profile-link">Profile</a>
        <a href="#" id="settings-link">Settings</a>
    </div>

    <div class="main-content">
        <div class="header">
            <div>
                <h1 id="main-title">Moderation Central</h1>
                <p id="main-description">Review and moderate user-submitted problems and suggestions.</p>
            </div>
            <div class="user-info">
                <button id="notification-bell">🔔<span id="notification-count" style="display: none;"></span></button>
            </div>
        </div>
        
        <div id="posts-view">
            <div class="card">
                <h3>Post Tracker</h3>
                <input type="text" id="search-input" onkeyup="filterPosts()" placeholder="Search posts by subject, user, or content...">
                <table id="post-table">
                    <thead>
                        <tr><th>ID</th><th>Type</th><th>Subject</th><th>Status</th><th>User</th><th>Actions</th></tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </div>

        <div id="users-view" class="hidden">
             <div class="card">
                <h3>Registered Users</h3>
                <input type="text" id="user-search-input" onkeyup="filterUsers()" placeholder="Search users by username or email...">
                <table>
                    <thead>
                        <tr><th>ID</th><th>Username</th><th>Email</th><th>Role</th><th>Status</th><th>Actions</th></tr>
                    </thead>
                    <tbody id="user-table-body">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="profile-view" class="hidden">
            <div class="card" style="max-width: 400px; margin: 0 auto;">
                <h3>Your Administrator Profile</h3>
                <div id="current-profile-avatar" class="avatar-container">👤</div>
                <div class="form-group">
                    <label for="profile-pic-input">Change Picture:</label>
                    <input type="file" id="profile-pic-input" accept="image/*">
                </div>
                <div class="form-group">
                    <label for="profile-name">Name:</label>
                    <input type="text" id="profile-name" required>
                </div>
                <div class="form-group">
                    <label for="profile-username">Username:</label>
                    <input type="text" id="profile-username" required>
                </div>
                <div class="form-group">
                    <label for="profile-role">Role:</label>
                    <input type="text" id="profile-role" disabled>
                </div>
                <div class="form-group">
                    <label for="profile-email">Email:</label>
                    <input type="email" id="profile-email" required>
                </div>
                <button id="save-profile-btn" class="btn-primary">Save Changes</button>
                
                <button id="reset-password-btn" class="btn-warning">Reset Password</button>

                <button id="logout-btn-profile" class="btn-danger">Logout</button>
            </div>
        </div>

        <div id="settings-view" class="hidden">
            <div class="card">
                <h3>Display Settings</h3>
                <div class="toggle-switch">
                    <label for="dark-mode-toggle">Enable Dark Mode</label>
                    <input type="checkbox" id="dark-mode-toggle">
                </div>
                <div class="toggle-switch">
                    <label for="high-contrast-toggle">High Contrast Mode</label>
                    <input type="checkbox" id="high-contrast-toggle">
                </div>
                
                <hr style="margin: 20px 0;">
                
                <h3>Moderation Defaults</h3>
                <div class="form-group">
                    <label for="default-status">Default New Post Status:</label>
                    <select id="default-status">
                        <option value="New">New</option>
                        <option value="In Progress">In Progress</option>
                    </select>
                </div>
                 <div class="form-group">
                    <label for="rows-per-page">Tickets per page (5-50):</label>
                    <input type="number" id="rows-per-page" min="5" max="50">
                </div>
                
                <hr style="margin: 20px 0;">
                
                <h3>Notification Settings</h3>
                <div class="toggle-switch">
                    <label for="notify-user-status">Notify on user status change (Ban/Unban)</label>
                    <input type="checkbox" id="notify-user-status">
                </div>
                <div class="toggle-switch">
                    <label for="notify-new-comment">Notify on new comments to tracked posts</label>
                    <input type="checkbox" id="notify-new-comment">
                </div>
                
                <button id="save-settings-btn" class="btn-primary">Save Settings</button>
            </div>
            
            <div class="card">
                <h3>Maintenance Actions</h3>
                <button id="archive-old-data-btn" class="btn-primary" style="background-color: #f39c12;">Archive Resolved Tickets</button>
                <button id="clear-notifications-btn" class="btn-primary" style="background-color: #7f8c8d;">Clear Read Notifications</button>
            </div>
        </div>

    </div>
    
    <div id="details-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeDetailsModal()">&times;</span>
            <h2 id="modal-title">Ticket Details</h2>
            <p>ID: <strong id="modal-id"></strong> | Subject: <strong id="modal-subject"></strong></p>
            
            <h4 style="margin-top: 20px;">Content:</h4>
            <p id="modal-content" style="border: 1px dashed #ccc; padding: 10px;"></p>
            
            <h4 style="margin-top: 20px;">Comments (<span id="comment-count">0</span>):</h4>
            <ul id="comments-list" style="list-style: none; padding: 0;">
                </ul>
        </div>
    </div>
    
    <div id="notification-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeNotificationModal()">&times;</span>
            <h2>Notifications</h2>
            <ul id="notification-list" style="list-style: none; padding: 0;">
                </ul>
        </div>
    </div>


    <script>
        // --- Mock Database: POSTS (Initial Data) ---
        let posts = [
            { 
                id: 101, 
                type: 'Problem', 
                subject: 'Wi-Fi slow in North Dorm', 
                content: 'The campus Wi-Fi speed drops significantly after 7 PM in the North Dorm block. Students cannot attend online classes.', 
                status: 'New', 
                user: 'Aisha K.',
                isFavorite: false,
                comments: [
                    { id: 1, user: 'Admin', text: 'Thanks for the report. Escalating to IT.' },
                    { id: 2, user: 'Ben J.', text: 'I second this. It\'s unusable.' },
                    { id: 3, user: 'User 404', text: 'This is a totally inappropriate comment and should be deleted.' }
                ]
            },
            { 
                id: 102, 
                type: 'Suggestion', 
                subject: 'Add more study pods in the library', 
                content: 'Suggest adding more soundproof study pods on the third floor for group work.', 
                status: 'Resolved', 
                user: 'Chris T.',
                isFavorite: false, 
                comments: []
            },
            { 
                id: 103, 
                type: 'Problem', 
                subject: 'Broken Water Fountain near Gym', 
                content: 'The water fountain has been leaking for a week. Needs urgent repair.', 
                status: 'In Progress', 
                user: 'Dana M.',
                isFavorite: false, 
                comments: [
                    { id: 4, user: 'Admin', text: 'Plumbing team is on it.' }
                ]
            }
        ];

        // --- Mock Database: USERS ---
        let users = [
            { id: 1, username: 'Aisha K.', email: 'aisha.k@college.edu', role: 'Student', status: 'Active' },
            { id: 2, username: 'Chris T.', email: 'chris.t@college.edu', role: 'Student', status: 'Active' },
            { id: 3, username: 'Prof. Smith', email: 'smith.p@college.edu', role: 'Faculty', status: 'Active' },
            { id: 4, username: 'User 404', email: 'user404@college.edu', role: 'Student', status: 'Banned' }
        ];

        // --- Mock Database: CURRENT ADMIN (Initial Data) ---
        let currentAdmin = {
            id: 1001,
            username: 'Moderator_Alpha',
            email: 'admin@collegecentral.edu',
            role: 'Senior Moderator',
            status: 'Active (Full Access)',
            avatarUrl: '',
            // Mock Password for Reset Functionality - Stored in Plain Text for this mock demo
            password: 'password123' 
        };

        // --- Mock Database: ADMIN SETTINGS (Initial Data) ---
        let adminSettings = {
            darkMode: false,
            highContrast: false,
            defaultPostStatus: 'New',
            rowsPerPage: 10,
            notifyUserStatus: true,
            notifyNewComment: true
        };

        // --- Mock Notifications ---
        let notifications = [
            { id: 1, message: "New Problem posted: 'Wi-Fi slow in North Dorm'", unread: true },
            { id: 2, message: "User 'Ben J.' replied to ticket 101.", unread: true },
            { id: 3, message: "System backup completed successfully.", unread: false }
        ];


        // --- DOM Element Declarations ---
        const $ = (id) => document.getElementById(id);

        const postTableBody = document.querySelector('#post-table tbody');
        const userTableBody = $('user-table-body');
        const postsView = $('posts-view');
        const usersView = $('users-view');
        const profileView = $('profile-view');
        const settingsView = $('settings-view'); 
        const mainTitle = $('main-title');
        const mainDescription = $('main-description');
        const notificationModal = $('notification-modal');
        const notificationList = $('notification-list');
        const notificationCount = $('notification-count');
        const detailsModal = $('details-modal');
        const commentsList = $('comments-list');
        const profilePicInput = $('profile-pic-input');
        const currentProfileAvatar = $('current-profile-avatar');
        const saveProfileBtn = $('save-profile-btn');
        const saveSettingsBtn = $('save-settings-btn');
        const logoutBtnProfile = $('logout-btn-profile');
        const resetPasswordBtn = $('reset-password-btn');


        // ----------------------------------------------------------------------
        //                                DATA PERSISTENCE
        // ----------------------------------------------------------------------

        function loadPersistentData() {
            // 1. Load Admin Profile
            const savedProfile = localStorage.getItem('adminProfile');
            if (savedProfile) {
                currentAdmin = JSON.parse(savedProfile);
                // Ensure the mock password exists if not saved before
                if (!currentAdmin.password) {
                     currentAdmin.password = 'password123';
                }
            } else {
                 // Set initial mock data if no local storage found
                 localStorage.setItem('adminProfile', JSON.stringify(currentAdmin));
            }
            
            // 2. Load Settings
            const savedSettings = localStorage.getItem('adminSettings');
            if (savedSettings) {
                adminSettings = JSON.parse(savedSettings);
            }
        }


        // ----------------------------------------------------------------------
        //                                VIEW SWITCHING
        // ----------------------------------------------------------------------

        function setActiveLink(clickedLink) {
            document.querySelector('.sidebar a.active')?.classList.remove('active');
            clickedLink.classList.add('active');
        }

        function showView(viewName) {
            // Hide all views first
            postsView.classList.add('hidden');
            usersView.classList.add('hidden');
            profileView.classList.add('hidden');
            settingsView.classList.add('hidden'); 

            // Show the requested view
            if (viewName === 'posts') {
                postsView.classList.remove('hidden');
                mainTitle.textContent = "Moderation Central";
                mainDescription.textContent = "Review and moderate user-submitted problems and suggestions.";
                // Note: renderPosts is called in the event listeners for dashboard/favorites
            } else if (viewName === 'users') {
                usersView.classList.remove('hidden');
                mainTitle.textContent = "User Management Console";
                mainDescription.textContent = "View, search, and manage user accounts and statuses.";
                renderUsers(users); 
            } else if (viewName === 'profile') {
                profileView.classList.remove('hidden');
                mainTitle.textContent = "Edit Administrator Profile";
                mainDescription.textContent = "Update your credentials and account settings.";
                renderProfile(currentAdmin);
            } else if (viewName === 'settings') { 
                settingsView.classList.remove('hidden');
                mainTitle.textContent = "Application Settings";
                mainDescription.textContent = "Manage dashboard display and application defaults.";
                loadAdminSettings(); 
            }
        }


        // ----------------------------------------------------------------------
        //                             PROFILE & SIDEBAR RENDERING
        // ----------------------------------------------------------------------

        function renderSidebarProfile(admin) {
            const sidebarUserCard = $('sidebar-user-card');
            const sidebarAdminName = $('sidebar-admin-name');
            
            sidebarAdminName.textContent = admin.username.toUpperCase();
            
            let avatarDiv = sidebarUserCard.querySelector('.user-avatar');
            // Clear previous content
            avatarDiv.innerHTML = '';
            
            if (admin.avatarUrl) {
                const avatarImg = document.createElement('img');
                avatarImg.src = admin.avatarUrl;
                avatarImg.setAttribute('alt', 'Admin Avatar');
                avatarDiv.appendChild(avatarImg);
            } else {
                // Use initials if no picture
                const initials = admin.username.substring(0, 2).toUpperCase();
                avatarDiv.textContent = initials;
            }
        }

        function renderProfile(admin) {
            // Update Form fields
            $('profile-name').value = admin.username; 
            $('profile-username').value = admin.username;
            $('profile-role').value = admin.role;
            $('profile-email').value = admin.email;
            
            // Update Profile View Avatar
            if (admin.avatarUrl) {
                currentProfileAvatar.innerHTML = `<img src="${admin.avatarUrl}" alt="Admin Avatar">`;
            } else {
                currentProfileAvatar.innerHTML = '👤'; 
            }
        }

        function handleProfilePictureChange(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentAdmin.avatarUrl = e.target.result; 
                    renderProfile(currentAdmin);
                    alert('New profile picture loaded! Click "Save Changes" to finalize.');
                };
                reader.readAsDataURL(file);
            }
        }

        function saveProfileChanges() {
            const newName = $('profile-name').value.trim();
            const newUsername = $('profile-username').value.trim();
            const newEmail = $('profile-email').value.trim();

            if (!newName || !newUsername || !newEmail) {
                alert("Please fill out all required fields.");
                return;
            }

            currentAdmin.username = newUsername; 
            currentAdmin.email = newEmail;
            
            // Save to Local Storage for persistence
            localStorage.setItem('adminProfile', JSON.stringify(currentAdmin));

            // Update UI elements
            renderSidebarProfile(currentAdmin); 
            renderProfile(currentAdmin); 
            
            alert(`Profile updated successfully! New Username: ${newUsername}`);
        }

        // Password Reset Functionality
        function handlePasswordReset() {
            const oldPassword = prompt("Please enter your current password:");
            
            if (oldPassword === null) return; // User cancelled

            if (oldPassword !== currentAdmin.password) {
                alert("Error: The current password you entered is incorrect.");
                return;
            }

            const newPassword = prompt("Enter your NEW password (must be at least 6 characters):");

            if (newPassword === null) return; // User cancelled
            
            if (newPassword.length < 6) {
                alert("Error: New password must be at least 6 characters long.");
                return;
            }

            const confirmPassword = prompt("Confirm your NEW password:");

            if (confirmPassword === null) return; // User cancelled

            if (newPassword !== confirmPassword) {
                alert("Error: The new passwords do not match.");
                return;
            }

            // Update password in mock database and localStorage
            currentAdmin.password = newPassword;
            localStorage.setItem('adminProfile', JSON.stringify(currentAdmin));

            alert("Success! Your password has been updated. Please remember your new password.");
        }


        // ----------------------------------------------------------------------
        //                              SETTINGS FUNCTIONS
        // ----------------------------------------------------------------------

        function applyTheme() {
            const body = document.body;
            
            // Prioritize High Contrast mode if active, as it's the most extreme setting
            if (adminSettings.highContrast) {
                body.classList.add('high-contrast');
                body.classList.remove('dark-mode'); 
            } else {
                body.classList.remove('high-contrast');
                // Apply Dark Mode only if High Contrast is off
                if (adminSettings.darkMode) {
                    body.classList.add('dark-mode');
                } else {
                    body.classList.remove('dark-mode');
                }
            }
        }

        function loadAdminSettings() {
            // System & Display
            $('dark-mode-toggle').checked = adminSettings.darkMode;
            $('high-contrast-toggle').checked = adminSettings.highContrast;
            
            // Moderation Defaults
            $('default-status').value = adminSettings.defaultPostStatus;
            $('rows-per-page').value = adminSettings.rowsPerPage;

            // Notification Settings
            $('notify-user-status').checked = adminSettings.notifyUserStatus;
            $('notify-new-comment').checked = adminSettings.notifyNewComment;
            
            // Apply theme setting on load
            applyTheme(); 
        }

        function saveAdminSettings() {
            // 1. Gather values
            const darkMode = $('dark-mode-toggle').checked;
            const highContrast = $('high-contrast-toggle').checked;
            const defaultStatus = $('default-status').value;
            const rowsPerPage = parseInt($('rows-per-page').value, 10);
            const notifyUserStatus = $('notify-user-status').checked;
            const notifyNewComment = $('notify-new-comment').checked;
            
            if (rowsPerPage < 5 || rowsPerPage > 50 || isNaN(rowsPerPage)) {
                alert("Tickets per page must be between 5 and 50.");
                $('rows-per-page').value = adminSettings.rowsPerPage;
                return;
            }

            // 2. Update the mock data object
            adminSettings.darkMode = darkMode;
            adminSettings.highContrast = highContrast;
            adminSettings.defaultPostStatus = defaultStatus;
            adminSettings.rowsPerPage = rowsPerPage;
            adminSettings.notifyUserStatus = notifyUserStatus;
            adminSettings.notifyNewComment = notifyNewComment;

            // 3. Save to Local Storage
            localStorage.setItem('adminSettings', JSON.stringify(adminSettings));
            
            // 4. APPLY THEME on save
            applyTheme(); 

            // 5. Provide feedback
            alert('Application Settings saved successfully! Theme updated.');
        }

        // ----------------------------------------------------------------------
        //                              OTHER DASHBOARD FUNCTIONS
        // ----------------------------------------------------------------------

        function renderPosts(data) {
            postTableBody.innerHTML = '';
            const favCount = posts.filter(p => p.isFavorite && p.status !== 'Deleted').length;
            $('fav-count').textContent = favCount;
            
            data.forEach(post => {
                if (post.status !== 'Deleted') { 
                    const row = postTableBody.insertRow();
                    let statusClass = `status-${post.status.toLowerCase().replace(' ', '-')}`;
                    let typeClass = `tag tag-${post.type.toLowerCase()}`;
                    const starIcon = post.isFavorite ? '★' : '☆'; 
                    const favClass = post.isFavorite ? 'is-favorited' : '';

                    row.innerHTML = `
                        <td>${post.id}</td>
                        <td><span class="${typeClass}">${post.type}</span></td>
                        <td>${post.subject}</td>
                        <td><span class="${statusClass}">${post.status}</span></td>
                        <td>${post.user}</td>
                        <td>
                            <button class="action-btn btn-view" onclick="openDetailsModal(${post.id})">View</button>
                            <button class="action-btn btn-delete" onclick="deletePost(${post.id})">Delete</button>
                            <button class="btn-favorite ${favClass}" onclick="toggleFavorite(${post.id})">${starIcon}</button>
                        </td>
                    `;
                }
            });
        }
        window.toggleFavorite = function(postId) {
            const post = posts.find(p => p.id === postId);
            if (post) {
                post.isFavorite = !post.isFavorite; 
                // Re-render the current list (either all posts or just favorites)
                const currentLink = document.querySelector('.sidebar a.active')?.id;
                if (currentLink === 'favorites-link') {
                    const favoritePosts = posts.filter(p => p.isFavorite);
                    renderPosts(favoritePosts);
                } else {
                    renderPosts(posts); 
                }
            }
        }
        window.deletePost = function(postId) {
            if (!confirm('DANGER: Are you sure you want to delete this entire post? This action is not reversible.')) return;
            const postIndex = posts.findIndex(p => p.id === postId);
            if (postIndex !== -1) {
                posts[postIndex].status = 'Deleted'; 
                // Re-render the dashboard to remove the deleted post
                renderPosts(posts); 
                alert(`Post ${postId} has been marked as Deleted.`);
            }
        }
        window.filterPosts = function() {
            const searchTerm = $('search-input').value.toLowerCase();
            const filteredPosts = posts.filter(post => 
                (post.status !== 'Deleted') && (
                post.subject.toLowerCase().includes(searchTerm) ||
                post.content.toLowerCase().includes(searchTerm) ||
                post.type.toLowerCase().includes(searchTerm)
                )
            );
            renderPosts(filteredPosts);
        }
        function renderUsers(data) {
            userTableBody.innerHTML = '';
            data.forEach(user => {
                const row = userTableBody.insertRow();
                const statusClass = user.status.toLowerCase() === 'active' ? 'status-active' : 'status-banned';
                const actionText = user.status === 'Active' ? 'Ban User' : 'Unban User';
                const actionClass = user.status === 'Active' ? 'btn-ban' : 'btn-unban';

                row.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.username}</td>
                    <td>${user.email}</td>
                    <td>${user.role}</td>
                    <td class="${statusClass}">${user.status}</td>
                    <td>
                        <button class="btn-toggle-status ${actionClass}" onclick="toggleUserStatus(${user.id})">${actionText}</button>
                    </td>
                `;
            });
        }
        window.filterUsers = function() {
            const searchTerm = $('user-search-input').value.toLowerCase();
            const filteredUsers = users.filter(user => 
                user.username.toLowerCase().includes(searchTerm) ||
                user.email.toLowerCase().includes(searchTerm) ||
                user.role.toLowerCase().includes(searchTerm)
            );
            renderUsers(filteredUsers);
        }
        function renderNotifications() {
            notificationList.innerHTML = '';
            const unreadCount = notifications.filter(n => n.unread).length;
            
            notificationCount.textContent = unreadCount > 0 ? unreadCount : ''; 
            notificationCount.style.display = unreadCount > 0 ? 'block' : 'none';

            if (notifications.length === 0) {
                        notificationList.innerHTML = '<li>No new notifications.</li>';
                        return;
            }

            notifications.forEach(notification => {
                const li = document.createElement('li');
                li.textContent = notification.message;
                
                if (notification.unread) {
                    li.classList.add('unread');
                }

                li.onclick = () => markAsRead(notification.id);
                notificationList.appendChild(li);
            });
        }
        window.openNotificationModal = function() { notificationModal.style.display = 'flex'; }
        window.closeNotificationModal = function() { notificationModal.style.display = 'none'; }
        function markAsRead(id) {
            const notification = notifications.find(n => n.id === id);
            if (notification) {
                notification.unread = false;
                renderNotifications();
            }
        }
        window.openDetailsModal = function(postId) {
            const post = posts.find(p => p.id === postId);
            if (!post) return;
            $('modal-id').textContent = post.id;
            $('modal-subject').textContent = post.subject;
            $('modal-content').textContent = post.content;
            $('modal-title').textContent = `${post.type} - ID: ${post.id}`;
            
            commentsList.innerHTML = '';
            $('comment-count').textContent = post.comments.length;

            post.comments.forEach(comment => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <div><strong>${comment.user}:</strong> ${comment.text}</div>
                    <button class="action-btn btn-delete-comment" onclick="deleteComment(${post.id}, ${comment.id})">Delete</button>
                `;
                commentsList.appendChild(li);
            });
            detailsModal.style.display = 'flex';
        }
        window.deleteComment = function(postId, commentId) {
            if (!confirm('WARNING: Are you sure you want to delete this comment?')) return;
            const post = posts.find(p => p.id === postId);
            if (post) {
                post.comments = post.comments.filter(c => c.id !== commentId);
                // Re-open the modal to refresh the comment list
                openDetailsModal(postId); 
                alert(`Comment ${commentId} has been removed.`);
            }
        }
        window.closeDetailsModal = function() { detailsModal.style.display = 'none'; }
        
        // Close modals when clicking outside of them
        window.onclick = function(event) {
            if (event.target === detailsModal || event.target === notificationModal) {
                event.target.style.display = 'none';
            }
        }

        window.archiveOldData = function() {
            if (confirm("Are you sure you want to mock-archive resolved tickets? This will remove them from the dashboard view.")) {
                const resolvedCount = posts.filter(p => p.status === 'Resolved').length;
                if (resolvedCount === 0) {
                    alert("No resolved tickets found to archive.");
                    return;
                }
                posts = posts.filter(p => p.status !== 'Resolved');
                renderPosts(posts);
                alert(`${resolvedCount} ticket(s) have been successfully archived and removed from the dashboard.`);
            }
        }
        window.clearReadNotifications = function() {
            const readCount = notifications.filter(n => !n.unread).length;
            if (readCount === 0) {
                alert("No read notifications to clear.");
                return;
            }
            notifications = notifications.filter(n => n.unread);
            renderNotifications();
            alert(`${readCount} read notification(s) cleared.`);
        }


        // ----------------------------------------------------------------------
        //                        INITIALIZATION & EVENT LISTENERS
        // ----------------------------------------------------------------------

        document.addEventListener('DOMContentLoaded', () => {
            
            // 1. LOAD PERSISTENT DATA FIRST
            loadPersistentData(); 
            
            // Apply theme setting immediately based on loaded data
            applyTheme(); 

            // Attach Sidebar Handlers
            $('dashboard-link').onclick = function(e) {
                e.preventDefault();
                setActiveLink(e.target);
                showView('posts');
                renderPosts(posts); // Show all posts
            };

            $('favorites-link').onclick = function(e) {
                e.preventDefault();
                setActiveLink(e.target);
                const favoritePosts = posts.filter(p => p.isFavorite);
                showView('posts');
                renderPosts(favoritePosts); // Show only favorites
                mainTitle.textContent = "My Favorite Tickets ⭐";
                mainDescription.textContent = "Quick access to tickets you've marked as important.";
            };

            $('users-link').onclick = function(e) {
                e.preventDefault();
                setActiveLink(e.target);
                showView('users');
            };
            
            $('profile-link').onclick = function(e) {
                e.preventDefault();
                setActiveLink(e.target);
                showView('profile');
            };
            
            $('settings-link').onclick = function(e) {
                e.preventDefault();
                setActiveLink(e.target);
                showView('settings'); 
            };
            
            // --- ACTION BUTTON LISTENERS ---
            logoutBtnProfile.onclick = function() {
                alert('Logging out... Thank you for your service!');
                // In a real app, this clears the session and redirects to login.
            };
            
            // Reset Password Listener
            resetPasswordBtn.addEventListener('click', handlePasswordReset);

            $('notification-bell').onclick = openNotificationModal;
            
            // --- PROFILE FUNCTIONALITY LISTENERS ---
            profilePicInput.addEventListener('change', handleProfilePictureChange);
            saveProfileBtn.addEventListener('click', saveProfileChanges);
            
            // --- SETTINGS FUNCTIONALITY LISTENERS ---
            saveSettingsBtn.addEventListener('click', saveAdminSettings);
            $('archive-old-data-btn').addEventListener('click', archiveOldData);
            $('clear-notifications-btn').addEventListener('click', clearReadNotifications);
            
            
            // --- Initial Render ---
            renderPosts(posts);
            renderNotifications();
            loadAdminSettings(); 
            showView('posts'); 
            
            // Render profile and sidebar using the loaded persistent data
            renderSidebarProfile(currentAdmin);
            renderProfile(currentAdmin);
        });
    </script>
</body>
</html>